---

- name: Ensure the latest version of podman is present
  ansible.builtin.dnf:
    name: podman
    state: latest

- name: Ensure the data dir is present
  loop:
    - "{{ config.path }}/certs"
    - "{{ storage.host.data }}"
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ user }}"
    group: "{{ user }}"
    mode: '0755'

- name: Ensure OpenBao configuration is present
  ansible.builtin.template:
    src: config.hcl.j2
    dest: "{{ config.path }}/config.hcl"
    mode: u=rw,g=r,o=r

- name: Ensure private key and certificate are copied
  loop:
    - { "src" : "{{ certs.localhost.private_key_path }}", "dest" : "{{ certs.host.private_key_path }}" }
    - { "src" : "{{ certs.localhost.certificate_path }}", "dest" : "{{ certs.host.certificate_path }}" }
  ansible.builtin.copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    mode: 755

- name: Ensure OpenBao pod is present
  containers.podman.podman_container:
    name: openbao-server
    image: "{{ image.registry }}:{{ image.tag }}"
    command: "bao server -dev -config=/etc/bao/config/config.hcl"
    user: "{{ user }}"
    volume:
      - "{{ config.path }}/config.hcl:/etc/bao/config/config.hcl:z"
      - "{{ certs.host.certificate_path }}:{{ certs.container.certificate_path }}:z"
      - "{{ certs.host.private_key_path }}:{{ certs.container.private_key_path }}:z"
      - "{{ storage.host.data }}:{{ storage.container.data }}:z"
    expose:
      - 8200
      - 8201
      - 8202
    ports:
      - "8200:8200"
      - "8201:8201"
      - "8202:8202"